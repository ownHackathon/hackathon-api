#!/usr/bin/env bash

# --- Konfiguration ---
CONTAINER_PHP="php"
DOCKER_COMPOSE="docker compose"

# --- Hilfsfunktionen (Provisioning) ---

# Hilfsfunktion für Statusmeldungen
log() { echo -e "\033[0;32m[INFO]\033[0m $1"; }

# 1. Startet die Container
up() {
    log "Starte Container..."
    $DOCKER_COMPOSE up -d
}

# 2. Installiert Abhängigkeiten (nur wenn nötig oder erzwungen)
install_deps() {
    if [ ! -d "./vendor" ] || [ "$1" == "--force" ]; then
        log "Installiere PHP-Abhängigkeiten..."
        $DOCKER_COMPOSE exec $CONTAINER_PHP composer install
    fi
}

# 3. Bereitet die Datenbank vor (Warten + Migrationen)
migrate_db() {
    log "Warte auf Datenbank..."
    $DOCKER_COMPOSE exec $CONTAINER_PHP php -r "
        \$start = time();
        while (true) {
            try {
                new PDO('mysql:host=db;port=3306', 'root', 'root');
                break;
            } catch (Exception \$e) {
                if (time() - \$start > 30) exit(1);
                echo '.'; sleep(1);
            }
        }"

    log "Führe Migrationen aus..."
    $DOCKER_COMPOSE exec $CONTAINER_PHP composer run doctrine migrations:sync-metadata-storage -- --no-interaction
    $DOCKER_COMPOSE exec $CONTAINER_PHP composer run doctrine migrations:migrate -- --no-interaction
}

# Die "Bau-Kette" (wird von setup und reset genutzt)
build_stack() {
    up
    install_deps "$1"
    migrate_db
}

# --- Command Handler ---

case $1 in
  "start")
    up
    ;;

  "stop")
    $DOCKER_COMPOSE stop
    ;;

  "setup")
    build_stack
    ;;

  "reset")
    log "Reset-Vorgang gestartet..."

    case $2 in
      "all")
        log "Modus: Alles (Volumes, Images, Vendor)"
        $DOCKER_COMPOSE down -v --rmi local
        [ -d "./vendor" ] && rm -rf "./vendor"
        FORCE_FLAG="--force"
        ;;
      "vendor")
        log "Modus: Datenbank + Vendor"
        $DOCKER_COMPOSE down -v
        [ -d "./vendor" ] && rm -rf "./vendor"
        FORCE_FLAG="--force"
        ;;
      *)
        log "Modus: Nur Datenbank (Standard)"
        $DOCKER_COMPOSE down -v
        FORCE_FLAG=""
        ;;
    esac

    # Nach dem Abbau folgt immer der identische Aufbau
    build_stack $FORCE_FLAG
    log "Reset erfolgreich abgeschlossen."
    ;;

  "composer")
    $DOCKER_COMPOSE exec $CONTAINER_PHP composer "${@:2}"
    ;;

  "php"|"indocker")
    $DOCKER_COMPOSE exec $CONTAINER_PHP "${@:2}"
    ;;

  *)
    echo "Verwendung: $0 {start|stop|setup|reset|composer|php}"
    echo ""
    echo "Reset-Optionen:"
    echo "  $0 reset          -> Löscht nur DB-Daten (behält Images & Vendor)"
    echo "  $0 reset vendor   -> Löscht DB-Daten & Vendor-Ordner"
    echo "  $0 reset all      -> Löscht ALLES (Volumes, lokale Images, Vendor)"
    ;;
esac
