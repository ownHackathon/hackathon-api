#!/usr/bin/env bash

# --- Konfiguration ---
CONTAINER_PHP="php"
DOCKER_COMPOSE="docker compose"

# --- Hilfsfunktionen (Provisioning) ---

log() { echo -e "\033[0;32m[INFO]\033[0m $1"; }

# 1. Startet die Container
up() {
    log "Starte Container..."
    $DOCKER_COMPOSE up -d
}

# 2. Beendet und entfernt Container & Netzwerke (behält Volumes)
down() {
    log "Fahre Container herunter und entferne Netzwerke..."
    $DOCKER_COMPOSE down
}

# 3. Installiert Abhängigkeiten (nur wenn nötig oder erzwungen)
install_deps() {
    if [ ! -d "./vendor" ] || [ "$1" == "--force" ]; then
        log "Installiere PHP-Abhängigkeiten..."
        $DOCKER_COMPOSE exec $CONTAINER_PHP composer install
    fi
}

# 4. Bereitet die Datenbank vor (Warten + Migrationen)
migrate_db() {
    log "Warte auf Datenbank..."
    $DOCKER_COMPOSE exec $CONTAINER_PHP php -r "
        \$start = time();
        while (true) {
            try {
                new PDO('mysql:host=db;port=3306', 'root', 'root');
                break;
            } catch (Exception \$e) {
                if (time() - \$start > 30) { echo 'Timeout!'; exit(1); }
                echo '.'; sleep(1);
            }
        }"

    log "Führe Migrationen aus..."
    $DOCKER_COMPOSE exec $CONTAINER_PHP composer run doctrine migrations:sync-metadata-storage -- --no-interaction
    $DOCKER_COMPOSE exec $CONTAINER_PHP composer run doctrine migrations:migrate -- --no-interaction
}

generate_openapi() {
    log "Generiere OpenAPI Dokumentation..."
    $DOCKER_COMPOSE exec $CONTAINER_PHP composer run openapi
}


# Bau-Kette
build_stack() {
    up
    install_deps "$1"
    migrate_db
    generate_openapi
}

# --- Command Handler ---

case $1 in
  "start")
    up
    ;;

  "stop")
    log "Stoppe Container (Pause)..."
    $DOCKER_COMPOSE stop
    ;;

  "down")
    down
    ;;

  "setup")
    build_stack
    ;;

   "openapi")
      generate_openapi
      ;;

  "reset")
    log "Reset-Vorgang gestartet..."

    case $2 in
      "all")
        log "Modus: Alles (Volumes, Images, Vendor)"
        $DOCKER_COMPOSE down -v --rmi local
        [ -d "./vendor" ] && rm -rf "./vendor"
        FORCE_FLAG="--force"
        ;;
      "vendor")
        log "Modus: Datenbank + Vendor"
        $DOCKER_COMPOSE down -v
        [ -d "./vendor" ] && rm -rf "./vendor"
        FORCE_FLAG="--force"
        ;;
      *)
        log "Modus: Nur Datenbank (Standard)"
        $DOCKER_COMPOSE down -v
        FORCE_FLAG=""
        ;;
    esac

    build_stack $FORCE_FLAG
    log "Reset erfolgreich abgeschlossen."
    ;;

  "composer")
    $DOCKER_COMPOSE exec $CONTAINER_PHP composer "${@:2}"
    ;;

  "php")
      # Hier wird 'php' automatisch vorangestellt
      $DOCKER_COMPOSE exec $CONTAINER_PHP php "${@:2}"
      ;;

  "indocker")
      # Hier wird der Befehl 1:1 durchgereicht
      $DOCKER_COMPOSE exec $CONTAINER_PHP "${@:2}"
      ;;

  *)
      echo "Usage: $0 {start|stop|down|setup|reset|openapi|composer|php|indocker}"
      echo ""
      echo "Commands:"
      echo "  start          - Start containers"
      echo "  stop           - Stop containers (pause)"
      echo "  down           - Remove containers & networks"
      echo "  setup          - Prepare project (install, migrate & generate openapi)"
      echo "  openapi        - Regenerate API documentation"
      echo ""
      echo "Reset Options:"
      echo "  reset          - Delete database only"
      echo "  reset vendor   - Delete database & vendor/ folder"
      echo "  reset all      - Delete everything (volumes, local images, vendor/)"
      echo ""
      echo "Utility Commands (inside PHP container):"
      echo "  composer [...] - Execute Composer commands"
      echo "                   Ex: $0 composer install"
      echo "  php [...]      - Execute PHP scripts/commands (prefixes 'php')"
      echo "                   Ex: $0 php bin/console cache:clear"
      echo "                   Ex: $0 php -v"
      echo "  indocker [...] - Execute any system command in the container"
      echo "                   Ex: $0 indocker ls -la"
      exit 1
      ;;
esac
