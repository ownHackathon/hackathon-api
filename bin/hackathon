#!/usr/bin/env bash

# --- Configuration ---
CONTAINER_PHP="php"
DOCKER_COMPOSE="docker compose"

# Get project name (directory name, lowercase)
PROJECT_NAME=$(basename "$PWD" | tr '[:upper:]' '[:lower:]')

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Load environment variables from .env if present
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
fi

# --- Helper Functions ---

log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Check if a specific container is running
is_running() {
    [ "$(docker inspect -f '{{.State.Running}}' "$1" 2>/dev/null)" == "true" ]
}

# List all valid service names defined in this project
list_services() {
    log "Available services in this project:"
    echo "-----------------------------------------------------------"
    echo -e "  ${GREEN}php${NC}              - PHP Application Container"
    echo -e "  ${GREEN}apache${NC}           - Web Server (Apache)"
    echo -e "  ${GREEN}database${NC}         - MariaDB Main Instance"
    echo -e "  ${GREEN}database-testing${NC} - MariaDB Testing Instance"
    echo -e "  ${GREEN}mailhog${NC}          - Mail Testing Service"
    echo "-----------------------------------------------------------"
}

# Robust check for initialization
check_initialization() {
    local initialized=true

    # 1. Check for vendor directory
    if [ ! -d "vendor" ]; then
        warn "Dependency check failed: directory 'vendor/' is missing."
        initialized=false
    fi

    # 2. Check for database volumes
    local volume_exists=$(docker volume ls -q --filter "label=com.docker.compose.project" --filter "label=com.docker.compose.volume=db")

    if [ -z "$volume_exists" ]; then
        warn "Infrastructure check failed: Database volume 'db' not found."
        initialized=false
    fi

    if [ "$initialized" = false ]; then
        error "Project is not fully initialized."
        echo -e "Please run ${GREEN}./bin/hackathon setup${NC} to initialize the environment."
        exit 1
    fi
}

show_info() {
    echo ""
    log "Service Connectivity Information:"
    echo "-----------------------------------------------------------"
    if is_running "hackathon-apache"; then
        echo -e "Web Interface:     http://localhost:${HTTP_PORT:-80}"
        echo -e "API Documentation: http://localhost:${HTTP_PORT:-80}/api/docs/"
    fi
    if is_running "hackathon-mailhog"; then
        echo -e "Mailhog Web-UI:    http://localhost:${MAILHOG_WEBUI_PORT:-8025}"
        echo -e "Mailhog SMTP Port: localhost:${MAILHOG_SMTP_PORT:-1025}"
    fi
    if is_running "hackathon-mariadb"; then
        echo -e "Database (App):    localhost:${MYSQL_PUBLIC_PORT:-3306}"
        echo -e "                   User: ${MYSQL_USER:-dev} | Pass: ${MYSQL_PASSWORD:-dev}"
    fi
    if is_running "hackathon-mariadb-testing"; then
        echo -e "Database (Test):   localhost:${MYSQL_TESTING_PORT:-3307}"
        echo -e "                   User: ${MYSQL_USER:-dev} | Pass: ${MYSQL_PASSWORD:-dev}"
    fi
    echo "-----------------------------------------------------------"
    echo ""
}

up() {
    log "Starting containers..."
    $DOCKER_COMPOSE up -d
}

down() {
    log "Stopping containers and removing networks..."
    $DOCKER_COMPOSE down
}

cleanup_docker() {
    log "Starting full Docker cleanup (containers, volumes, images)..."
    $DOCKER_COMPOSE down -v --rmi all --remove-orphans
    log "All Docker resources have been removed."
}

cleanup_app() {
    log "Cleaning application files and caches (preserving .gitkeep)..."

    # 1. Remove entire directories
    local dirs=(".phplint.cache" ".phpunit.cache" ".phpunit.functional.cache" "vendor")
    for dir in "${dirs[@]}"; do
        if [ -d "$dir" ]; then
            rm -rf "$dir" && log "-> $dir/ removed"
        fi
    done

    # 2. Clear contents of directories, but EXCLUDE .gitkeep
    local content_dirs=("data/cache" "data/log")
    for c_dir in "${content_dirs[@]}"; do
        if [ -d "$c_dir" ]; then
            # find: mindepth 1 (only contents), ! -name (not .gitkeep), -delete (remove)
            find "$c_dir" -mindepth 1 ! -name ".gitkeep" -delete && log "-> contents of $c_dir/ cleared (except .gitkeep)"
        fi
    done

    # 3. Remove specific files
    if [ -f ".phpcs-cache" ]; then
        rm ".phpcs-cache" && log "-> .phpcs-cache removed"
    fi
}

install_deps() {
    if [ ! -d "./vendor" ] || [ "$1" == "--force" ]; then
        log "Installing PHP dependencies..."
        $DOCKER_COMPOSE exec $CONTAINER_PHP composer install
    fi
}

migrate_db() {
    log "Waiting for database readiness..."
    $DOCKER_COMPOSE exec $CONTAINER_PHP php -r "
        \$start = time();
        while (true) {
            try {
                new PDO('mysql:host=database;port=3306', 'root', '${MYSQL_ROOT_PASSWORD:-root}');
                break;
            } catch (Exception \$e) {
                if (time() - \$start > 30) { echo 'Timeout!'; exit(1); }
                echo '.'; sleep(1);
            }
        }"
    echo ""
    log "Running migrations..."
    $DOCKER_COMPOSE exec $CONTAINER_PHP composer run doctrine migrations:sync-metadata-storage -- --no-interaction
    $DOCKER_COMPOSE exec $CONTAINER_PHP composer run doctrine migrations:migrate -- --no-interaction
}

generate_openapi() {
    log "Generating OpenAPI documentation..."
    $DOCKER_COMPOSE exec $CONTAINER_PHP composer run openapi
}

build_stack() {
    up
    install_deps "$1"
    migrate_db
    generate_openapi
    show_info
}

# --- Command Handler ---

case $1 in
  "start")
    check_initialization
    up
    show_info
    ;;
  "stop")
    log "Pausing containers..."
    $DOCKER_COMPOSE stop
    ;;
  "down")
    down
    ;;
  "setup")
    build_stack
    ;;
  "openapi")
    generate_openapi
    ;;
  "info")
    show_info
    ;;
  "services")
    list_services
    ;;
  "logs")
    if [ -z "$2" ]; then
        $DOCKER_COMPOSE logs -f
    else
        case $2 in
          php|apache|database|database-testing|mailhog) $DOCKER_COMPOSE logs -f "$2" ;;
          *) list_services; echo -e "Usage: $0 logs {${GREEN}svc${NC}}"; exit 1 ;;
        esac
    fi
    ;;
  "test")
    $DOCKER_COMPOSE exec $CONTAINER_PHP vendor/bin/phpunit "${@:2}"
    ;;
  "mysql")
    log "Connecting to Database Console..."
    $DOCKER_COMPOSE exec database mariadb -u "${MYSQL_USER:-dev}" -p"${MYSQL_PASSWORD:-dev}" "${MYSQL_DATABASE:-db}"
    ;;
  "bash")
    log "Entering PHP container..."
    $DOCKER_COMPOSE exec $CONTAINER_PHP sh -c "which bash > /dev/null && bash || sh"
    ;;
  "clean")
    case $2 in
      "docker") cleanup_docker ;;
      "app")    cleanup_app ;;
      "all")    cleanup_docker; cleanup_app ;;
      *)
        echo -e "Usage: $0 clean {${GREEN}docker${NC}|${GREEN}app${NC}|${GREEN}all${NC}}"
        echo ""
        echo "Options:"
        echo -e "  ${GREEN}docker${NC}   - Remove all project containers, networks, volumes and ALL images"
        echo -e "  ${GREEN}app${NC}      - Remove vendor/ folder, all cache directories and clear logs (preserves .gitkeep)"
        echo -e "  ${GREEN}all${NC}      - Full cleanup (Combines both docker and app cleanup)"
        exit 1
        ;;
    esac
    ;;
  "reset")
    case $2 in
      "database")
        log "Resetting database..."
        $DOCKER_COMPOSE down -v
        build_stack
        ;;
      "vendor")
        log "Resetting vendor folder..."
        [ -d "vendor" ] && rm -rf "vendor"
        up
        install_deps "--force"
        show_info
        ;;
      "all")
        log "Resetting entire application stack..."
        $DOCKER_COMPOSE down -v
        cleanup_app
        build_stack "--force"
        ;;
      *)
        echo -e "Usage: $0 reset {${GREEN}database${NC}|${GREEN}vendor${NC}|${GREEN}all${NC}}"
        echo ""
        echo "Options:"
        echo -e "  ${GREEN}database${NC} - Wipe database volumes and re-run migrations (restarts containers)"
        echo -e "  ${GREEN}vendor${NC}   - Wipe vendor/ folder and reinstall dependencies (DB stays untouched)"
        echo -e "  ${GREEN}all${NC}      - Wipe database, vendor/ and ALL caches, then perform fresh setup"
        exit 1
        ;;
    esac
    ;;
  "composer")
    $DOCKER_COMPOSE exec $CONTAINER_PHP composer "${@:2}"
    ;;
  "php")
    $DOCKER_COMPOSE exec $CONTAINER_PHP php "${@:2}"
    ;;
  "indocker")
    case $2 in
      php|apache|database|database-testing|mailhog)
        SERVICE=$2
        COMMAND=${@:3}
        if [ -z "$COMMAND" ]; then
            log "Entering $SERVICE container..."
            $DOCKER_COMPOSE exec "$SERVICE" sh -c "which bash > /dev/null && bash || sh"
        else
            $DOCKER_COMPOSE exec "$SERVICE" $COMMAND
        fi
        ;;
      *)
        list_services
        echo -e "Usage: $0 indocker {${GREEN}svc${NC}} [command]"
        exit 1
        ;;
    esac
    ;;
  *)
    echo -e "Usage: $0 {${GREEN}start${NC}|${GREEN}stop${NC}|${GREEN}down${NC}|${GREEN}setup${NC}|${GREEN}reset${NC}|${GREEN}openapi${NC}|${GREEN}info${NC}|${GREEN}clean${NC}|${GREEN}composer${NC}|${GREEN}php${NC}|${GREEN}indocker${NC}}"
    echo ""
    echo "Infrastructure Commands:"
    echo -e "  ${GREEN}start${NC}           - Start containers (checks for initialization first)"
    echo -e "  ${GREEN}stop${NC}            - Pause containers (preserves state)"
    echo -e "  ${GREEN}down${NC}            - Stop and remove containers and networks"
    echo -e "  ${GREEN}setup${NC}           - Full initial installation (Start, Install, Migrate, OpenAPI)"
    echo -e "  ${GREEN}info${NC}            - Show connectivity info (URLs, Ports, Credentials)"
    echo -e "  ${GREEN}services${NC}        - List all available service names"
    echo -e "  ${GREEN}openapi${NC}         - Regenerate the OpenAPI documentation"
    echo ""
    echo "Maintenance Commands:"
    echo -e "  ${GREEN}clean [...]${NC}     - Delete resources (run without args for options)"
    echo -e "  ${GREEN}reset [...]${NC}     - Restart with fresh data (run without args for options)"
    echo ""
    echo "Utility & Development:"
    echo -e "  ${GREEN}composer [...]${NC}  - Execute Composer commands"
    echo -e "  ${GREEN}php [...]${NC}       - Execute PHP scripts"
    echo -e "  ${GREEN}test [...]${NC}      - Run PHPUnit tests"
    echo -e "  ${GREEN}logs [svc]${NC}      - Tail logs for all or a specific service"
    echo -e "  ${GREEN}bash${NC}            - Shortcut to enter PHP container"
    echo -e "  ${GREEN}mysql${NC}           - Shortcut to enter Database CLI"
    echo -e "  ${GREEN}indocker [svc]${NC}  - Access a specific container"
    exit 1
    ;;
esac
